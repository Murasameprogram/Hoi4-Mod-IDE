## 开发日志

### 2025-12-22
**项目正式立项**  
今天正式决定启动“钢铁雄心4 Mod IDE”项目。目标是为《钢铁雄心4》模组开发者打造一款集成开发环境，简化模组制作流程，提高开发效率。团队由两人组成：一人负责核心开发与UI设计，另一人负责策划、翻译与运营。项目采用.NET 9 + WPF技术栈，并计划使用Wpf.Ui库构建现代化界面。  
**运行环境规划**：开发阶段使用Windows 11 + Visual Studio 2022，目标运行环境为Windows 10/11（64位），需安装.NET 9.0桌面运行时。

### 2025-12-26
**初次定位：小型Mod项目辅助开发**  
经过初步需求分析，我们决定将第一版重点放在小型模组项目上，主要功能包括民族精神、国家焦点、简单事件等基础编辑器的开发。目标是让个人或小型团队能够快速创建和调整模组内容，降低入门门槛。同时，开始设计项目文件结构和数据模型。  
**今日进度**：完成了解决方案的基础搭建，引入了Wpf.Ui和CommunityToolkit.Mvvm包，创建了主窗口原型。

### 2025-12-30
**第一个内部测试版完成，发现关键Bug**  
我们快速开发了民族精神编辑器的基本界面，并打包了第一个内部测试版。测试中发现两个严重问题：  
1. **民族精神列表加载缓慢**：当项目包含超过50个民族精神时，界面卡顿明显。  
   - **严重程度**：中等  
   - **复现概率**：高（文件数>50时必现）  
   - **运行环境**：Windows 11 64位，.NET 6.0  
   - **原因**：使用ObservableCollection直接绑定大量数据且未启用虚拟化。  
   - **Bug代号**：BUG-A001  
2. **保存文件时偶发崩溃**：在快速连续保存时，有时会抛出“文件被占用”异常。  
   - **严重程度**：严重  
   - **复现概率**：中（约30%的保存操作）  
   - **运行环境**：所有Windows版本  
   - **原因**：文件写入未正确处理异步冲突。  
   - **Bug代号**：BUG-S001  

**修复计划**：将列表控件启用虚拟化，并重写文件保存逻辑，使用临时文件+替换策略。

### 2026-01-03
**修复上述Bug，并开始考虑大型Mod支持**  
- **BUG-A001修复**：为ListBox添加VirtualizingStackPanel，并优化数据源，加载100个条目从3秒降至0.5秒。(bug:BUG-A001已归档)  
- **BUG-S001修复**：引入FileStream写操作的独占锁重试机制，并在后台线程执行写入，避免UI卡顿。测试连续保存100次未再崩溃。(bug:BUG-S001已归档)  

在内部讨论中，我们意识到未来可能需要支持大型Mod项目。现有架构难以应对数千个文件的管理和实时预览。为此，我们决定扩展功能范围，增加对事件链、决策系统、科技树等复杂内容的可视化编辑，并开始研究模块化设计。

### 2026-01-07
**架构转型决定：由集成式转为插件化**  
随着功能范围的急剧扩大，原有的集成式架构已难以满足灵活扩展和长期维护。今天团队正式决定重构项目，将软件核心与功能模块解耦，转为插件化架构。核心将负责项目管理、UI框架、插件加载、日志等基础服务，各个编辑器作为独立插件提供。  

**技术决策**：  
- 插件接口：定义IPlugin接口，包含初始化、菜单注册等。  
- 插件发现：使用MEF（System.ComponentModel.Composition）或自定义Assembly扫描。  
- 依赖注入：将核心容器共享给插件，支持构造函数注入。  

**风险**：重构可能带来短期进度延迟，但长期将极大提升可维护性和可扩展性。

### 2026-01-12
**插件化原型开发，发现MEF兼容性问题**  
我们基于MEF实现了初步的插件加载框架，并编写了“民族精神编辑器”作为示例插件。测试中遇到一个Bug：  
- **插件程序集锁定问题**：在开发过程中频繁重新编译插件时，主程序无法覆盖旧插件DLL，提示“文件正在使用”。  
   - **严重程度**：中等  
   - **复现概率**：高（每次重新编译后启动主程序时）  
   - **运行环境**：Windows 10/11  
   - **原因**：MEF的AssemblyCatalog会锁定加载的程序集，直到AppDomain卸载。  
   - **Bug代号**：BUG-A002  

**解决方案**：改用DirectoryCatalog并设置AppDomain.AssemblyResolve事件，或者采用Shadow Copy机制。决定短期内使用DirectoryCatalog，并在插件目录中动态加载，但需注意清理旧文件。

### 2026-01-16
**修复插件锁定问题，添加日志系统**  
- **BUG-A002修复**：将插件加载改为每次启动时复制插件到临时目录，再从临时目录加载，避免锁定原文件。此方法解决了开发时的频繁覆盖问题，但增加了启动开销。经测试，5个插件加载时间增加约200ms，可接受。(bug:BUG-A002已归档)  
- 同时，集成了Microsoft.Extensions.Logging，添加了日志文件输出（位置：`%AppData%\HOI4ModIDE\Logs`），方便追踪内部测试发现的Bug。

### 2026-01-20
**内部测试：事件编辑器界面卡死**  
在测试事件编辑器时，发现编辑复杂事件时界面偶尔无响应。  
- **Bug详情**：事件编辑器包含条件块和作用块，当嵌套层级超过5层时，界面渲染和滚动变得极其卡顿。  
   - **严重程度**：中等  
   - **复现概率**：中（仅在复杂事件中复现，测试中约20%的复杂事件触发）  
   - **运行环境**：Windows 11，.NET 6.0  
   - **原因**：TreeView控件未启用虚拟化，且递归数据模板导致性能下降。  
   - **Bug代号**：BUG-A003  

**修复**：将TreeView替换为支持虚拟化的第三方控件（AvalonEdit的折叠树），并优化数据结构，只展开可见节点。修复后，嵌套10层的事件也能流畅浏览。(bug:BUG-A003已归档)

### 2026-01-24
**插件安装路径权限问题**  
为了便于后续共享插件，我们设计了插件安装功能，允许用户从本地选择插件文件并安装到软件目录。测试安装功能时发现：  
- **Bug**：当软件安装在需要管理员权限的目录（如`C:\Program Files`）时，尝试将插件复制到安装目录下会因权限不足失败。  
   - **严重程度**：严重  
   - **复现概率**：高（若用户自定义安装到受限目录）  
   - **运行环境**：Windows UAC开启状态  
   - **Bug代号**：BUG-S002  

**修复**：将插件默认存储路径改为`%AppData%\HOI4ModIDE\Plugins`，该目录用户始终有写权限。安装程序检测到旧路径时自动迁移。(bug:BUG-S002已归档)

### 2026-01-28
**本地化功能基本完成，遇到编码Bug**  
软件需支持多语言（中/英），我们采用WPFLocalizationExtension + resx资源文件。测试中文界面时发现：  
- **Bug**：部分控件的中文显示为乱码。  
   - **严重程度**：中等  
   - **复现概率**：高（所有中文文本）  
   - **运行环境**：所有Windows版本  
   - **原因**：resx文件默认保存为UTF-8 with BOM，但WPF资源读取时未指定编码。  
   - **Bug代号**：BUG-A004  

**修复**：在生成资源时强制保存为UTF-8 without BOM，并在XAML中显式设置字体支持中文（如“Microsoft YaHei”）。(bug:BUG-A004已归档)

### 2026-02-01
**重大Bug：启动时崩溃，因显卡驱动兼容性**  
在旧电脑（集成显卡）上测试时，软件启动即崩溃。  
- **Bug详情**：崩溃发生在Wpf.Ui初始化时，调用`ApplyMica`方法失败。  
   - **严重程度**：严重  
   - **复现概率**：低（仅影响不支持Mica效果的旧系统，测试中约10%的旧设备复现）  
   - **运行环境**：Windows 10 1809以下版本或不支持DWM模糊的显卡驱动  
   - **Bug代号**：BUG-S003  

**修复**：在应用Mica效果前检查操作系统版本和DWM支持，若不支持则回退到普通Acrylic或纯色背景。增加try-catch并记录异常，避免崩溃。(bug:BUG-S003已归档)

### 2026-02-04
**性能优化：项目加载速度提升**  
测试大型项目（超过5000个文件）时，加载时间过长，达到30秒以上。分析发现瓶颈在文件遍历和解析。  
- **优化措施**：使用`Directory.EnumerateFiles`并行遍历，并缓存文件修改时间，仅在文件变更时重新解析。加载时间降至8秒左右。  
- **Bug修复**：并行遍历时偶尔出现“文件正在被其他进程使用”异常（杀毒软件扫描导致）。  
   - **严重程度**：轻微  
   - **复现概率**：低（约1%）  
   - **Bug代号**：BUG-B001  
   - **修复**：添加重试机制，跳过无法访问的文件并记录警告。(bug:BUG-B001已归档)

### 2026-02-08
**内部测试v0.5.0版本，发现新Bug**  
我们打包了v0.5.0内部测试版，进行全功能测试，发现几个问题：  
1. **插件安装后不显示**：安装插件后，重启软件菜单中未出现插件入口。  
   - **严重程度**：中等  
   - **复现概率**：高（每次安装新插件后）  
   - **原因**：插件发现机制未处理新添加的插件，需重新扫描目录。  
   - **Bug代号**：BUG-A005  
2. **崩溃报告窗口不显示详情**：当软件崩溃时，弹窗只显示“未知错误”，没有日志路径提示。  
   - **严重程度**：轻微  
   - **复现概率**：高（每次崩溃时）  
   - **原因**：全局异常处理未输出详细信息。  
   - **Bug代号**：BUG-B002  
3. **文件监视器内存泄漏**：软件内置文件监视器，当用户在外部修改模组文件时自动刷新。测试发现长时间运行后内存占用持续增长。  
   - **严重程度**：中等  
   - **复现概率**：高（运行超过4小时后）  
   - **原因**：FileSystemWatcher的事件未正确注销，导致handler堆积。  
   - **Bug代号**：BUG-A006  

**修复计划**：将在下个版本集中修复。

### 2026-02-11
**修复上述Bug，稳定性提升**  
- **BUG-A005修复**：在软件启动时扫描所有插件，并添加“刷新插件”按钮，支持手动刷新插件列表。(bug:BUG-A005已归档)  
- **BUG-B002修复**：改进全局异常处理，显示友好消息并指明日志文件位置。(bug:BUG-B002已归档)  
- **BUG-A006修复**：在项目关闭时注销所有事件，并使用弱事件模式避免内存泄漏。(bug:BUG-A006已归档)  
- 新增插件依赖冲突检测：测试中发现两个插件引用不同版本的同一NuGet包时，可能导致加载失败。  
   - **严重程度**：严重  
   - **复现概率**：低（仅当插件开发者引用特定版本时）  
   - **Bug代号**：BUG-S004  
   - **修复**：在插件加载时使用AssemblyResolve事件进行版本重定向，优先使用高版本。(bug:BUG-S004已归档)  
- 同时优化了插件扫描性能，减少启动时间。

### 2026-02-14
**情人节特别更新：插件化架构确认完善**  
今天是情人节，目前V0.5.0内部测试版已经正式标记归档，我们今天已经发布了v0.6.0内部测试版，标志着插件化架构已基本稳定。目前核心功能包括：项目管理、民族精神编辑器、事件编辑器（基础版）、插件加载与管理、本地化支持、日志系统。所有Bug均为内部测试发现并修复，未对外公开。  
- **稳定性总结**：经过多轮测试，软件在主流Windows 10/11系统上运行稳定，启动时间控制在3秒内，大型项目加载时间约8秒。内存占用在正常编辑状态下保持在200MB以内。  
- **目前更新计划**：继续完善插件API文档，开发更多官方插件（如科技树编辑器、国家焦点编辑器），并考虑引入插件市场机制，为未来公开测试做准备。 


### 2026-02-16
**春节停更通知**<br>
今晚是除夕夜，该项目将停止更新5天， 2026年2月21日（正月初五）将恢复更新，祝大家春节快乐✧٩(ˊωˋ*)و✧！

---

2026年2月16日<br>
巴斯塔胡空间站
